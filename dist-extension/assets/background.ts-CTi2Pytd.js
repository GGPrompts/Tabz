import{r as N,a as y,g as k}from"./storage-CzyTXWyI.js";import{p as T}from"./utils-CESIIj3x.js";let n=null,S=null;const g=5e3,d="ws://localhost:8129",p=new Set;console.log("Terminal Tabs background service worker starting...");function u(){if((n==null?void 0:n.readyState)===WebSocket.OPEN){console.log("WebSocket already connected");return}console.log("Connecting to backend WebSocket:",d),n=new WebSocket(d),n.onopen=()=>{console.log("âœ… Background WebSocket connected"),m(),s({type:"WS_CONNECTED"})},n.onmessage=e=>{var t,a;try{const o=JSON.parse(e.data);if(console.log("ğŸ“¨ WS message received:",o.type,o.type==="terminal-spawned"?JSON.stringify(o).slice(0,200):""),o.type==="output"||o.type==="terminal-output")console.log("ğŸ“Ÿ Terminal output received, broadcasting to clients:",(t=o.terminalId)==null?void 0:t.slice(-8),(a=o.data)==null?void 0:a.length,"bytes"),s({type:"TERMINAL_OUTPUT",terminalId:o.terminalId,data:o.data});else{const r={type:"WS_MESSAGE",data:o};o.type==="terminal-spawned"&&console.log("ğŸ“¤ Broadcasting to clients:",JSON.stringify(r).slice(0,200)),s(r)}}catch(o){console.error("Failed to parse WebSocket message:",o)}},n.onerror=e=>{console.error("âŒ WebSocket error:",{url:d,readyState:n==null?void 0:n.readyState,readyStateText:(n==null?void 0:n.readyState)===0?"CONNECTING":(n==null?void 0:n.readyState)===1?"OPEN":(n==null?void 0:n.readyState)===2?"CLOSING":(n==null?void 0:n.readyState)===3?"CLOSED":"UNKNOWN",error:e})},n.onclose=e=>{console.log("WebSocket closed:",{code:e.code,reason:e.reason||"(no reason provided)",wasClean:e.wasClean,url:d}),n=null,s({type:"WS_DISCONNECTED"}),S&&clearTimeout(S),S=setTimeout(u,g)}}function c(e){(n==null?void 0:n.readyState)===WebSocket.OPEN?n.send(JSON.stringify(e)):console.warn("WebSocket not connected, cannot send:",e)}function s(e){p.forEach(t=>{try{t.postMessage(e)}catch(a){console.error("Failed to send message to client:",a),p.delete(t)}})}async function m(){const e=await k();chrome.action.setBadgeText({text:e>0?String(e):""}),chrome.action.setBadgeBackgroundColor({color:"#4CAF50"})}chrome.runtime.onMessage.addListener(async(e,t,a)=>{var o;switch(console.log("ğŸ“¬ Message received from extension:",e.type),e.type){case"OPEN_SESSION":try{const l=await chrome.windows.getAll({windowTypes:["normal"]}),i=l.find(I=>I.focused)||l[0];i!=null&&i.id?(console.log("[Background] Opening side panel in window:",i.id),await chrome.sidePanel.open({windowId:i.id})):console.error("[Background] No normal browser window found")}catch(l){console.error("[Background] Failed to open side panel:",l)}c({type:"attach-terminal",sessionName:e.sessionName});break;case"SPAWN_TERMINAL":const r=`spawn-${Date.now()}`;c({type:"spawn",config:{terminalType:e.spawnOption||"bash",command:e.command||"",workingDirectory:e.cwd},requestId:r}),console.log("ğŸ“¤ Spawning terminal:",{terminalType:e.spawnOption,command:e.command,cwd:e.cwd,requestId:r}),e.spawnOption&&(y(`${e.spawnOption}-${Date.now()}`),m());break;case"CLOSE_SESSION":c({type:"close-terminal",sessionName:e.sessionName}),N(e.sessionName),m();break;case"CLOSE_TERMINAL":c({type:"close-terminal",terminalId:e.terminalId});break;case"TERMINAL_INPUT":console.log("ğŸ“¥ TERMINAL_INPUT:",{terminalId:e.terminalId,dataLength:(o=e.data)==null?void 0:o.length}),c({type:"command",terminalId:e.terminalId,command:e.data});break;case"TERMINAL_RESIZE":console.log("ğŸ“ TERMINAL_RESIZE:",{terminalId:e.terminalId,cols:e.cols,rows:e.rows}),c({type:"resize",terminalId:e.terminalId,cols:e.cols,rows:e.rows});break;case"UPDATE_BADGE":m();break;default:c(e)}return!0});chrome.runtime.onConnect.addListener(e=>{console.log("ğŸ”Œ Client connected:",e.name),p.add(e);const t=(n==null?void 0:n.readyState)===WebSocket.OPEN;e.postMessage({type:"INITIAL_STATE",wsConnected:t}),e.onDisconnect.addListener(()=>{console.log("ğŸ”Œ Client disconnected:",e.name),p.delete(e)}),e.onMessage.addListener(a=>{chrome.runtime.sendMessage(a)})});chrome.runtime.onInstalled.addListener(()=>{console.log("Installing context menus..."),chrome.contextMenus.create({id:"terminal-tabs",title:"Terminal Tabs",contexts:["all"]}),chrome.contextMenus.create({id:"open-url-in-terminal",parentId:"terminal-tabs",title:"Open URL in Terminal",contexts:["link"]}),chrome.contextMenus.create({id:"run-command",parentId:"terminal-tabs",title:"Run in Terminal",contexts:["selection"]}),chrome.contextMenus.create({id:"open-sidepanel",parentId:"terminal-tabs",title:"Open Side Panel",contexts:["all"]})});chrome.contextMenus.onClicked.addListener((e,t)=>{switch(console.log("Context menu clicked:",e.menuItemId),e.menuItemId){case"open-url-in-terminal":if(e.linkUrl){const a=T(e.linkUrl);chrome.runtime.sendMessage({type:"SPAWN_TERMINAL",cwd:a||void 0,command:`echo "Opened from: ${e.linkUrl}"`})}break;case"run-command":e.selectionText&&chrome.runtime.sendMessage({type:"SPAWN_TERMINAL",command:e.selectionText});break;case"open-sidepanel":t!=null&&t.windowId&&chrome.sidePanel.open({windowId:t.windowId});break}});u();setInterval(()=>{console.log("ğŸ“ Background service worker alive"),(n==null?void 0:n.readyState)!==WebSocket.OPEN&&u()},25e3);console.log("âœ… Terminal Tabs background service worker initialized");
